# https://github.com/lguzzon-DOCKER/docker-cordova/blob/develop/Dockerfile
# https://raw.githubusercontent.com/lguzzon-DOCKER/docker-cordova/develop/Dockerfile

# https://github.com/lguzzon-scratchbook/cordova-web-wrap/blob/feature/abotLucaGuzzon/buildReleaseApk.sh
# https://raw.githubusercontent.com/lguzzon-scratchbook/cordova-web-wrap/feature/abotLucaGuzzon/buildReleaseApk.sh

# https://github.com/youstinus/volunteer/blob/master/.travis.yml
# https://raw.githubusercontent.com/youstinus/volunteer/master/.travis.yml

# https://docs.travis-ci.com/user/languages/android/

dist: xenial
sudo: false


matrix:
  include:
  -
    language: android
    os: linux
    dist: xenial
    jdk: oraclejdk8
    sudo: required
    android:
      components:
      - tools
      - platform-tools
      - build-tools-29.0.3
      - android-27
      - android-28
      - android-29
      - extra-google-google_play_services
      - extra-google-m2repository
      - extra-android-m2repository
    licenses:
    - android-sdk-preview-license-.+
    - android-sdk-license-.+
    - android-googletv-license-.+
    - google-gdk-license-.+
    - intel-android-extra-license-.+
    - mips-android-sysimage-license-.+
    before_install:
    - export LANG=en_US.UTF-8
    - git clone "https://$U:$P@gitlab.com/lguzzon-ubuntu/lib.git"
    - cd lib
    - git checkout develop
    - cd ..
    - chmod +x ./lib/tool/libInstall.sh
    - ./lib/tool/libInstall.sh
    - toolManager.sh -ffsend_i
    - sudo dpkg --add-architecture i386
    - sudo apt install -y openssl ca-certificates
    - nvm install "12.18.1"
    - node --version
    - npm --version
    - npm i -g --unsafe-perm=true --allow-root "cordova@latest" "phonegap@latest" "@ionic/cli@latest" "framework7-cli@latest" "cordova-check-plugins"
    - cordova --version
    - cordova telemetry off
    - phonegap --version
    - phonegap analytics off
    - ionic --version
    - framework7 --version
    - cordova-check-plugins --version
    install:
    - (cordova platform remove android || true)
    - (cordova platform remove android || true)
    - (cordova platform add android || true)
    - cordova requirements android
    - cordova-check-plugins --update=auto
    - cordova plugin save
    - cordova prepare
    - cordova build android --release
    - (rm keystore.PKCS12 || true)
    - keytool -genkey -alias aliasKeystore -keyalg RSA -keystore ./keystore.PKCS12 -dname "CN=Luca Guzzon, OU=Mobilez, O=SolonSoft, L=Siena, S=Toscana, C=IT" -storepass storepass1qaz2wsX  -keysize 4096  -validity 10000 -deststoretype pkcs12
    - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore keystore.PKCS12 -storepass storepass1qaz2wsX ./platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk aliasKeystore
    - (rm release.apk || true)
    - $(find / -iname zipalign 2>/dev/null | head -1) -v 4 ./platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk release.apk
    - sudo chown -R $(whoami):$(whoami) .
    - sudo chown -R $(whoami):$(whoami) *
    - ffsend u release.apk -p p 
